"""
this module contains the command-line interface for webster.
it provides a CLI for scraping a website and saving the content locally.
"""

import os
import asyncio

import click

from webster import (
    __version__ as version,
    wlog,
    Embedder,
    Scraper,
    C,
)


@click.group()
def cli() -> None:
    """
    entrypoint for the webster CLI.
    """

    pass


@cli.command()
@click.argument("url")
@click.option(
    "--depth",
    "-d",
    default=3,
    help="the maximum depth to scrape. defaults to 3.",
)
@click.option(
    "--include",
    "-i",
    multiple=True,
    help="only scrape URLs that start with this path. can be used multiple times.",
    default=[],
)
@click.option(
    "--tag-name", "-t", help="only scrape the first tag with this name on the page."
)
@click.option(
    "--out-format",
    "-f",
    help="the output format for saving scraped content. accepts 'html' or 'md', defaults to 'md'.",
    default="md",
)
@click.option(
    "--webster-path",
    "-W",
    help="the path to create the '.webster' directory inside. defaults to './.webster'.",
    default=".webster",
)
def scrape(
    url: str,
    depth: int,
    include: list,
    tag_name: str,
    out_format: str,
    webster_path: str,
) -> None:
    """
    scrape a website and save the content locally.
    depth is the maximum number of link-outs to follow from the URL.
    """

    if include is None:
        include = ["/"]
    else:
        include = [i if i.startswith("/") else f"/{i}" for i in include]

    out_format = out_format or ""
    if out_format.lower() not in {"html", "md", "urls"}:
        wlog(
            "warn",
            "Invalid output format!",
            "Defaulting to 'urls'.",
            marker=False,
            label=True,
        )
        out_format = "urls"

    scraper = Scraper(
        site=url,
        depth=depth,
        include_paths=include,
        tag_filter={"name": tag_name} if tag_name else None,
        output_format=out_format or "md",
        webster_path=webster_path,
    )

    asyncio.run(scraper.run())

    wlog(
        "success",
        "scraping completed!",
        f"sitemap saved to '{os.sep.join([webster_path, 'scrape', 'sitemap.json'])}.",
    )


@cli.command()
@click.option(
    "--docs-format",
    "-f",
    default="md",
    help="the format of the text documents. defaults to 'md'.",
)
@click.option(
    "--embed-model",
    "-e",
    default="all-MiniLM-L6-v2",
    help="the name of the Hugging Face embedding model to use. defaults to 'all-MiniLM-L6-v2'.",
)
@click.option(
    "--chunk-size",
    "-cs",
    default=1000,
    help="the size of the chunks to split the text into. defaults to 1000.",
)
@click.option(
    "--chunk-overlap",
    "-co",
    default=200,
    help="the amount of overlap between chunks. defaults to 200.",
)
@click.option(
    "--webster-path",
    "-W",
    help="the path to the '.webster' directory created by 'webster scrape'. defaults to './.webster'.",
    default=".webster",
)
def embed(
    docs_format: str,
    embed_model: str,
    chunk_size: int,
    chunk_overlap: int,
    webster_path: str,
) -> None:
    """
    create embeddings for the documents generated by 'webster scrape'.
    """
    if not os.path.exists(os.path.join(webster_path, "scrape")):
        wlog(
            "error",
            "'scrape' directory not found!",
            (
                "make sure to run 'webster scrape' first, "
                + "and to pass in the path to the '.webster' directory with '-W'."
            ),
            label=True,
        )
        return

    docs_format = docs_format or ""
    if docs_format.lower() not in {"html", "md", "urls"}:
        wlog(
            "warn",
            "invalid document format!",
            "defaulting to 'urls'.",
            marker=False,
            label=True,
        )
        docs_format = "urls"

    wlog("note", "creating embedder...")
    embedder = Embedder(
        docs_format, embed_model, chunk_size, chunk_overlap, webster_path
    )

    embedder.embed()

    wlog(
        "success",
        "embedding completed!",
        "database saved.",
    )


def run() -> None:
    """
    entrypoint for the 'webster' command-line script.

    args:
        None

    returns:
        Nones
    """
    from rich.traceback import install

    install(show_locals=True)

    print(" . . . ")
    wlog("success", "webster", f"v{version}")
    cli()
